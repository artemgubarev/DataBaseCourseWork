{
  "connStr": "Data Source=SQL5111.site4now.net;Initial Catalog=db_a9e913_coursework;User Id=db_a9e913_coursework_admin;Password=flyg919st",
  "document": "with orderswithquantity as ( select o.id as orderid, o.shopid, o.providerid, po.productid, po.quantity as requestedquantity from orders o inner join productsinorders po on o.id = po.orderid ), supplieswithquantity as ( select s.id as supplyid, s.shopid, s.providerid, ps.productid, ps.quantity as deliveredquantity from supplies s inner join productsinsupplies ps on s.id = ps.supplyid ), stock as ( select ps.productid, sum(ps.quantity) as availablequantity from productsinstock ps group by ps.productid ) select s.name as shop, p.name as product, coalesce(sum(case when st.availablequantity >= sw.deliveredquantity then sw.deliveredquantity else st.availablequantity end), 0) as quantityinshop from shops s left join orderswithquantity ow on s.id = ow.shopid left join supplieswithquantity sw on s.id = sw.shopid left join stock st on sw.productid = st.productid left join products p on sw.productid = p.id group by s.name, p.name having coalesce(sum(case when st.availablequantity >= sw.deliveredquantity then sw.deliveredquantity else st.availablequantity end), 0) > 0 order by s.name, p.name;"
}